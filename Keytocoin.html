<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KeytoCoin Wallet</title>
<style>
body { background:#111;color:#0f0;font-family:monospace;padding:20px;overflow-x:hidden; }
button,input{ padding:6px 10px;background:#222;color:#0f0;border:1px solid #0f0;border-radius:6px;margin:2px; }
input{ width:250px; }
#log{ max-height:200px;overflow-y:auto;background:#222;padding:10px;border:1px solid #0f0; }

/* Coin rain */
.coin{position:fixed;top:-60px;width:50px;height:50px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ffd700,#c99700);box-shadow:0 0 10px #ff0,inset 0 0 10px #c90;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#111;font-size:14px;animation:fall linear forwards;z-index:-1;}
@keyframes fall{ to{ transform:translateY(110vh) rotate(360deg); opacity:0.8; } }

/* Trigonometric coin */
.trigCoin{position:fixed;top:0;width:40px;height:40px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#0ff,#08f);display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:12px;box-shadow:0 0 10px #0ff,inset 0 0 5px #08f;}

/* Brick Text */
.brick-text{ font-size:30px;font-weight:bold;display:inline-block;background:linear-gradient(90deg,#ff0000,#ff6600,#ffcc00);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:brickmove 3s linear infinite;}
@keyframes brickmove{ 0%{background-position:0% center;} 100%{background-position:200% center;} }
</style>
</head>
<body>

<h2>üîê KeytoCoin Wallet </h2>
<button id="createWalletBtn">Create Wallet</button>
<button id="clearWalletBtn">Clear Wallet</button>
<button id="startMiningBtn">Start Mining</button>
<button id="stopMiningBtn">Stop Mining</button>
<button id="saveAddressBtn">Save Address</button>

<p>Address: <span id="address"></span></p>
<p>Private: <span id="privkey"></span></p>
<p>Balance: <span id="balance">0</span> KTC</p>
<p>Bank Balance: Rp<span id="idrBalance">0</span></p>

<hr>
<h3>Mining</h3>
<p>Mined Blocks: <span id="blocks">0</span></p>
<p>Total Supply: <span id="supply">0</span> / 17,000,000 KTC</p>

<h3>Send Transaction</h3>
<input id="to" placeholder="Recipient Address">
<input id="amount" type="number" placeholder="Amount">
<button id="sendBtn">Send</button>

<hr>
<h3>Swap KTC ‚Üí IDR</h3>
<input id="swapAmount" type="number" placeholder="Amount of KTC">
<button id="swapBtn">Swap</button>
<p id="swapResult"></p>

<h3>Withdraw to Bank</h3>
<input id="bankAcc" type="text" placeholder="Bank Account Number">
<input id="withdrawAmount" type="number" placeholder="Amount in Rupiah">
<button id="withdrawBtn">Withdraw</button>
<p id="withdrawResult"></p>

<hr>
<h3>Saved Wallets</h3>
<ul id="savedWallets"></ul>

<hr>
<h3>Blockchain Log</h3>
<pre id="log"></pre>

<div align="center"><span class="brick-text">üß±‚õìÔ∏èKEYTOCOIN‚õìÔ∏èüß±</span></div>
<div align="center"><span class="brick-text">üß±‚õìÔ∏èBLOKCHAIN‚õìÔ∏èüß±</span></div>

<script>
const API = "http://localhost:3005";

fetch(`${API}/balance`)
  .then(r => r.json())
  .then(d => console.log("Balance:", d));

fetch(`${API}/create-wallet`)
  .then(r => r.json())
  .then(d => console.log("Wallet:", d));

let privKey=null, address=null, miningInterval=null;
let idrBalance = 0; // Reset all balances on load

// Reset all localStorage keys
localStorage.removeItem("KTC_Wallet");
localStorage.removeItem("KTC_IDR");
localStorage.removeItem("KTC_Saved");

function log(msg){ const logEl=document.getElementById("log"); const div=document.createElement("div"); div.textContent=msg; logEl.prepend(div); }

async function hash(data){ const buf=new TextEncoder().encode(data); const digest=await crypto.subtle.digest("SHA-256",buf); return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join(""); }

// Wallet
async function createWallet(){
  const arr=new Uint8Array(32); crypto.getRandomValues(arr);
  privKey=Array.from(arr).map(b=>b.toString(16).padStart(2,"0")).join("");
  const addrHash=await hash(privKey); address=addrHash.slice(0,32);
  localStorage.setItem("KTC_Wallet",JSON.stringify({privKey,address}));
  idrBalance=0; localStorage.setItem("KTC_IDR",idrBalance);
  log("‚úÖ Wallet created!"); updateDisplay();
}

function loadWallet(){ /* empty because reset */ }

function clearWallet(){
  localStorage.removeItem("KTC_Wallet"); privKey=null; address=null; stopMining(); updateDisplay(); log("üóëÔ∏è Wallet cleared."); 
  localStorage.removeItem("KTC_Saved"); renderSavedWallets();
  idrBalance=0; localStorage.setItem("KTC_IDR",0);
}

// Wallet info
async function getWalletInfo(){
  if(!address) return {balance:0,blocks:0,supply:0};
  try{ const res=await fetch(`${API}/wallet/${address}`); return await res.json(); }catch(e){ return {balance:0,blocks:0,supply:0}; }
}

async function updateDisplay(){
  document.getElementById("address").innerText = address||"";
  document.getElementById("privkey").innerText = privKey?privKey.slice(0,16)+"...":"";
  const info = await getWalletInfo();
  document.getElementById("balance").innerText = info.balance;
  document.getElementById("blocks").innerText = info.blocks;
  document.getElementById("supply").innerText = info.supply;
  document.getElementById("idrBalance").innerText = idrBalance.toLocaleString("id-ID");
}

// Mining
async function mineBlock(){
  if(!address){ log("‚ö†Ô∏è Create a wallet first!"); return; }
  try{
    const res = await fetch(`${API}/mine`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({address}) });
    const data = await res.json();
    if(data.error) log("‚ö†Ô∏è "+data.error); else log(`‚úÖ ${data.message} Block #${data.block.index}`);
    updateDisplay();
  }catch(e){ log("‚ö†Ô∏è Server error") }
}

function startMining(){ if(!miningInterval && address){ miningInterval=setInterval(mineBlock,5000); log("‚öôÔ∏è Mining started."); } }
function stopMining(){ clearInterval(miningInterval); miningInterval=null; log("üõë Mining stopped."); }

// Transactions
async function sendTransaction(){
  if(!privKey){ log("‚ö†Ô∏è Create wallet first!"); return; }
  let to=document.getElementById("to").value; let amount=parseInt(document.getElementById("amount").value);
  if(!to || !amount || amount<=0){ log("‚ö†Ô∏è Invalid input"); return; }
  const tx={from:address,to,amount,timestamp:Date.now()}; const sig=await hash(JSON.stringify(tx)); tx.signature=sig.slice(0,16);
  try{
    const res=await fetch(`${API}/send`,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(tx)});
    const data=await res.json(); if(data.error) log("‚ö†Ô∏è "+data.error); else log("‚ûï "+data.message); updateDisplay();
  }catch(e){ log("‚ö†Ô∏è Server error"); }
}

// Swap to IDR
async function swapKTC(){
  if(!address){ log("‚ö†Ô∏è Create wallet first!"); return; }
  let amount=parseInt(document.getElementById("swapAmount").value);
  if(!amount || amount<=0){ log("‚ö†Ô∏è Invalid input."); return; }
  const info = await getWalletInfo();
  if(info.balance < amount){ log("‚ö†Ô∏è Not enough KTC balance!"); return; }
  let swapped = amount * 10000;
  idrBalance += swapped;
  localStorage.setItem("KTC_IDR", idrBalance);
  document.getElementById("idrBalance").innerText = idrBalance.toLocaleString("id-ID");
  document.getElementById("swapResult").innerText = `‚úÖ Swap ${amount} KTC ‚Üí Rp${swapped.toLocaleString("id-ID")}`;
  log(`üîÑ Swap ${amount} KTC ‚Üí Rp${swapped.toLocaleString("id-ID")}`);
  updateDisplay();
}

// Withdraw to bank
function withdrawIDR(){
  let bankAcc = document.getElementById("bankAcc").value.trim();
  let amount = parseInt(document.getElementById("withdrawAmount").value);
  if(!bankAcc || !amount || amount<=0){ log("‚ö†Ô∏è Invalid input!"); return; }
  if(amount>idrBalance){ log("‚ö†Ô∏è Insufficient bank balance!"); return; }
  idrBalance -= amount;
  localStorage.setItem("KTC_IDR", idrBalance);
  document.getElementById("idrBalance").innerText = idrBalance.toLocaleString("id-ID");
  document.getElementById("withdrawResult").innerText=`üè¶ Withdraw Rp${amount.toLocaleString("id-ID")} to Bank ${bankAcc} successful.`;
  log(`üè¶ Withdraw Rp${amount.toLocaleString("id-ID")} to Bank ${bankAcc}`);
}

// Save wallet addresses
function saveWalletAddress(){
  if(!address) { log("‚ö†Ô∏è No wallet to save!"); return; }
  let saved = JSON.parse(localStorage.getItem("KTC_Saved")||"[]");
  if(!saved.includes(address)){ saved.push(address); localStorage.setItem("KTC_Saved", JSON.stringify(saved)); log("üíæ Address saved: "+address); renderSavedWallets(); } else log("‚ö†Ô∏è Address already saved."); 
}

function renderSavedWallets(){
  let saved = JSON.parse(localStorage.getItem("KTC_Saved")||"[]");
  const list = document.getElementById("savedWallets");
  list.innerHTML="";
  saved.forEach(addr=>{ let li=document.createElement("li"); li.textContent=addr; list.appendChild(li); });
}

// Coin rain
function createCoin(){ const coin=document.createElement("div"); coin.className="coin"; coin.innerText="KTC"; coin.style.left=Math.random()*window.innerWidth+"px"; coin.style.animationDuration=(3+Math.random()*2)+"s"; document.body.appendChild(coin); setTimeout(()=>coin.remove(),6000); }
setInterval(createCoin,600);

// Trigonometric coins
function createTrigCoin(){ const coin=document.createElement("div"); coin.className="trigCoin"; coin.innerText="KTC"; document.body.appendChild(coin); let t=0; let startX=Math.random()*window.innerWidth; let amplitude=50+Math.random()*50; let speed=0.02+Math.random()*0.02; function animate(){ t+=1; let y=t; let x=startX+Math.sin(t*speed)*amplitude; coin.style.transform=`translate(${x}px, ${y}px)`; if(y<window.innerHeight) requestAnimationFrame(animate); else coin.remove(); } animate(); }
setInterval(createTrigCoin,1500);

// Init
window.onload=()=>{
  document.getElementById("createWalletBtn").onclick=createWallet;
  document.getElementById("clearWalletBtn").onclick=clearWallet;
  document.getElementById("startMiningBtn").onclick=startMining;
  document.getElementById("stopMiningBtn").onclick=stopMining;
  document.getElementById("sendBtn").onclick=sendTransaction;
  document.getElementById("swapBtn").onclick=swapKTC;
  document.getElementById("withdrawBtn").onclick=withdrawIDR;
  document.getElementById("saveAddressBtn").onclick=saveWalletAddress;
  renderSavedWallets();
  updateDisplay();
};
</script>
</body>
</html>
